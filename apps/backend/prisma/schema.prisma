generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
  previewFeatures = ["multiSchema"] 
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["erp"]
}

model Organization {
  id                      String                  @id @default(uuid())
  name                    String
  absorbCreditCardFee     Boolean                 @default(false)
  creditCardReceiveDays   Int?                    @default(30)
  accountsRec             AccountRec[]
  appearanceSettings      AppearanceSettings?     @relation("AppearanceToOrganization")
  landingPages            LandingPage[]
  media                   Media[]
  menuItems               MenuItem[]
  products                Product[]
  sales                   Sale[]
  stockMovements          StockMovement[]
  users                   User[]
  xmlImportLogs           XmlImportLog[]
  accountsPay             AccountPay[]
  analisesQuimicas        AnaliseQuimica[]
  chemical_reactions      chemical_reactions[]
  clients                 Client[]
  contasContabeis         ContaContabil[]
  contasCorrentes         ContaCorrente[]
  creditCardBills         CreditCardBill[]
  CreditCardFee           CreditCardFee[]
  creditCards             CreditCard[]
  fornecedores            Fornecedor[]
  funcionarios            Funcionario[]
  inventoryLots           InventoryLot[]
  laborCostTableEntries   LaborCostTableEntry[]
  marketData              MarketData[]
  metalAccounts           MetalAccount[]
  metalCredits            MetalCredit[]
  metalReceivablePayments MetalReceivablePayment[]
  metalReceivables        MetalReceivable[]
  operationalCosts        OperationalCost[]
  paymentTerms            PaymentTerm[]
  pessoas                 Pessoa[]
  productGroups           ProductGroup[]
  purchaseOrders          PurchaseOrder[]
  pureMetalLotMovements   PureMetalLotMovement[]
  pure_metal_lots         pure_metal_lots[]
  quotations              Quotation[]
  rawMaterials            RawMaterial[]
  rawMaterialsUsed        RawMaterialUsed[]
  recoveryOrders          RecoveryOrder[]
  recuperacoes            Recuperacao[]
  saleAdjustments         SaleAdjustment[]
  tasks                   Task[]
  transacoes              Transacao[]
  whatsAppRoutines        WhatsAppRoutine[]
  themePresets            ThemePreset[]

  @@map("Organization")
  @@schema("erp")
}

model User {
  id             String        @id @default(uuid())
  email          String        @unique
  password       String
  name           String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  pessoaId       String?       @unique
  role           Role          @default(USER)
  organization   Organization  @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa?       @relation("UserToPessoa", fields: [pessoaId], references: [id])
  settings       UserSettings?
  tasks          Task[]

  @@map("User")
  @@schema("erp")
}

model UserSettings {
  id                          String  @id @default(uuid())
  userId                      String  @unique
  theme                       String  @default("system")
  language                    String  @default("pt-BR")
  defaultCaixaContaId         String?
  defaultDespesaContaId       String?
  defaultReceitaContaId       String?
  metalCreditPayableAccountId String?
  metalStockAccountId         String?
  productionCostAccountId     String?
  user                        User    @relation(fields: [userId], references: [id])

  @@map("UserSettings")
  @@schema("erp")
}

model Pessoa {
  id                          String            @id @default(uuid())
  organizationId              String
  type                        PessoaType
  name                        String
  razaoSocial                 String?
  email                       String?           @unique
  phone                       String?
  cpf                         String?           @unique
  cnpj                        String?           @unique
  birthDate                   DateTime?
  gender                      String?
  cep                         String?
  logradouro                  String?
  numero                      String?
  complemento                 String?
  bairro                      String?
  cidade                      String?
  uf                          String?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  externalId                  String?           @unique
  sales                       Sale[]            @relation("ClientSales")
  salespersonSales            Sale[]            @relation("SalespersonSales")
  user                        User?             @relation("UserToPessoa")
  analisesQuimicasComoCliente AnaliseQuimica[]  @relation("PessoaAnalisesQuimicas")
  client                      Client?
  fornecedor                  Fornecedor?
  funcionario                 Funcionario?
  metalAccounts               MetalAccount[]
  metalCredits                MetalCredit[]
  metalReceivables            MetalReceivable[]
  organization                Organization      @relation(fields: [organizationId], references: [id])
  recoveryOrdersAsSalesperson RecoveryOrder[]   @relation("SalespersonRecoveryOrders")

  @@map("pessoas")
  @@schema("erp")
}

model Client {
  pessoaId       String       @id
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa       @relation(fields: [pessoaId], references: [id], onDelete: Cascade)

  @@map("clients")
  @@schema("erp")
}

model Fornecedor {
  pessoaId               String          @id
  organizationId         String
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  defaultContaContabilId String?
  accountsPay            AccountPay[]
  defaultContaContabil   ContaContabil?  @relation(fields: [defaultContaContabilId], references: [id])
  organization           Organization    @relation(fields: [organizationId], references: [id])
  pessoa                 Pessoa          @relation(fields: [pessoaId], references: [id], onDelete: Cascade)
  purchaseOrders         PurchaseOrder[]
  transacoes             Transacao[]

  @@map("fornecedores")
  @@schema("erp")
}

model Funcionario {
  pessoaId       String       @id
  organizationId String
  hireDate       DateTime
  position       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa       @relation(fields: [pessoaId], references: [id], onDelete: Cascade)

  @@map("funcionarios")
  @@schema("erp")
}

model Product {
  id                        String                @id @default(uuid())
  name                      String
  description               String?
  price                     Decimal               @db.Decimal(10, 2)
  stock                     Float?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  organizationId            String
  costPrice                 Decimal?              @db.Decimal(10, 2)
  productGroupId            String?
  goldValue                 Float?
  externalId                String?               @unique
  stockUnit                 StockUnit             @default(GRAMS)
  organization              Organization          @relation(fields: [organizationId], references: [id])
  productGroup              ProductGroup?         @relation(fields: [productGroupId], references: [id])
  saleItems                 SaleItem[]
  stockMovements            StockMovement[]
  chemicalReactionsAsOutput chemical_reactions[]
  inventoryLots             InventoryLot[]
  purchaseOrderItems        PurchaseOrderItem[]

  @@map("Product")
  @@schema("erp")
}

model RawMaterial {
  id                 String              @id @default(uuid())
  organizationId     String
  name               String
  description        String?
  unit               StockUnit           @default(GRAMS)
  cost               Decimal             @db.Decimal(10, 2)
  isForResale        Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  stock              Float?              @default(0)
  purchaseOrderItems PurchaseOrderItem[]
  organization       Organization        @relation(fields: [organizationId], references: [id])
  rawMaterialsUsed   RawMaterialUsed[]

  @@map("raw_materials")
  @@schema("erp")
}

model ProductGroup {
  id                     String                   @id @default(uuid())
  organizationId         String
  name                   String
  description            String?
  commissionPercentage   Decimal?                 @db.Decimal(5, 2)
  isReactionProductGroup Boolean                  @default(false)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  adjustmentCalcMethod   SaleAdjustmentCalcMethod @default(QUANTITY_BASED)
  products               Product[]
  organization           Organization             @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("product_groups")
  @@schema("erp")
}

model InventoryLot {
  id                String              @id @default(uuid())
  organizationId    String
  productId         String
  batchNumber       String?             @unique
  costPrice         Decimal             @db.Decimal(10, 2)
  quantity          Float
  remainingQuantity Float
  sourceType        String
  sourceId          String
  notes             String?
  receivedDate      DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  stockMovements    StockMovement[]
  reaction          chemical_reactions? @relation("ReactionToBatch")
  organization      Organization        @relation(fields: [organizationId], references: [id])
  product           Product             @relation(fields: [productId], references: [id])
  saleItemLots      SaleItemLot[]

  @@map("inventory_lots")
  @@schema("erp")
}

model StockMovement {
  id             String        @id @default(uuid())
  productId      String
  type           String
  quantity       Float
  createdAt      DateTime      @default(now())
  organizationId String
  inventoryLotId String?
  sourceDocument String?
  inventoryLot   InventoryLot? @relation(fields: [inventoryLotId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id])
  product        Product       @relation(fields: [productId], references: [id])

  @@map("StockMovement")
  @@schema("erp")
}

model Sale {
  id                String            @id @default(uuid())
  orderNumber       Int               @unique
  totalAmount       Decimal           @db.Decimal(14, 2)
  feeAmount         Decimal?          @db.Decimal(10, 2)
  netAmount         Decimal?          @db.Decimal(14, 2)
  paymentMethod     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  organizationId    String
  paymentTermId     String?
  pessoaId          String
  goldPrice         Decimal?          @db.Decimal(10, 2)
  goldValue         Decimal?          @db.Decimal(10, 4)
  totalCost         Decimal?          @db.Decimal(14, 2)
  commissionAmount  Decimal?          @db.Decimal(10, 2)
  commissionDetails Json?
  externalId        String?           @unique
  status            SaleStatus        @default(PENDENTE)
  shippingCost      Decimal?          @db.Decimal(10, 2)
  readyForPayment   Boolean           @default(false)
  observation       String?
  salespersonId     String?
  accountsRec       AccountRec[]
  organization      Organization      @relation(fields: [organizationId], references: [id])
  paymentTerm       PaymentTerm?      @relation(fields: [paymentTermId], references: [id])
  pessoa            Pessoa            @relation("ClientSales", fields: [pessoaId], references: [id])
  salesperson       Pessoa?           @relation("SalespersonSales", fields: [salespersonId], references: [id])
  saleItems         SaleItem[]
  metalReceivable   MetalReceivable?
  pureMetalLots     pure_metal_lots[]
  adjustment        SaleAdjustment?
  installments      SaleInstallment[]

  @@map("Sale")
  @@schema("erp")
}

model PaymentTerm {
  id               String          @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  installmentsDays Int[]
  interestRate     Decimal?        @db.Decimal(5, 2)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  sales            Sale[]
  organization     Organization    @relation(fields: [organizationId], references: [id])
  purchaseOrders   PurchaseOrder[]

  @@unique([organizationId, name])
  @@map("payment_terms")
  @@schema("erp")
}

model SaleItem {
  id              String        @id @default(uuid())
  saleId          String
  productId       String
  quantity        Float
  price           Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  costPriceAtSale Decimal       @db.Decimal(10, 2)
  externalId      String?       @unique
  laborPercentage Decimal?      @db.Decimal(5, 2)
  product         Product       @relation(fields: [productId], references: [id])
  sale            Sale          @relation(fields: [saleId], references: [id])
  saleItemLots    SaleItemLot[]

  @@map("SaleItem")
  @@schema("erp")
}

model SaleItemLot {
  id             String       @id @default(uuid())
  saleItemId     String
  inventoryLotId String
  quantity       Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  inventoryLot   InventoryLot @relation(fields: [inventoryLotId], references: [id])
  saleItem       SaleItem     @relation(fields: [saleItemId], references: [id])

  @@unique([saleItemId, inventoryLotId])
  @@map("sale_item_lots")
  @@schema("erp")
}

model SaleInstallment {
  id                String                @id @default(uuid())
  saleId            String
  amount            Decimal
  dueDate           DateTime
  paidAt            DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  installmentNumber Int
  status            SaleInstallmentStatus
  accountRecId      String?
  accountRec        AccountRec?           @relation(fields: [accountRecId], references: [id])
  sale              Sale                  @relation(fields: [saleId], references: [id])

  @@map("sale_installments")
  @@schema("erp")
}

model AccountPay {
  id                   String         @id @default(uuid())
  description          String
  amount               Decimal        @db.Decimal(10, 2)
  dueDate              DateTime
  paid                 Boolean        @default(false)
  paidAt               DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  installmentNumber    Int?
  isInstallment        Boolean?
  totalInstallments    Int?
  contaContabilId      String?
  organizationId       String
  transacaoId          String?        @unique
  purchaseOrderId      String?
  fornecedorId         String?
  originalAccountId    String?
  goldAmount           Decimal?       @db.Decimal(12, 4)
  goldPrice            Decimal?       @db.Decimal(10, 2)
  recoveryReportPeriod String?
  contaContabil        ContaContabil? @relation(fields: [contaContabilId], references: [id])
  fornecedor           Fornecedor?    @relation(fields: [fornecedorId], references: [pessoaId])
  organization         Organization   @relation(fields: [organizationId], references: [id])
  originalAccount      AccountPay?    @relation("SplitFrom", fields: [originalAccountId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  splitAccounts        AccountPay[]   @relation("SplitFrom")
  purchaseOrder        PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  transacao            Transacao?     @relation(fields: [transacaoId], references: [id])

  @@map("accounts_pay")
  @@schema("erp")
}

model AccountRec {
  id                    String            @id @default(uuid())
  saleId                String?
  description           String
  amount                Decimal           @db.Decimal(10, 2)
  dueDate               DateTime
  received              Boolean           @default(false)
  receivedAt            DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  contaCorrenteId       String?
  organizationId        String
  transacaoId_old       String?           @unique @map("transacaoId")
  externalId            String?           @unique
  amountPaid            Decimal           @default(0) @db.Decimal(10, 2)
  goldAmount            Decimal?          @db.Decimal(12, 4)
  goldAmountPaid        Decimal?          @default(0) @db.Decimal(12, 4)
  doNotUpdateSaleStatus Boolean           @default(false)
  contaCorrente         ContaCorrente?    @relation(fields: [contaCorrenteId], references: [id])
  organization          Organization      @relation(fields: [organizationId], references: [id])
  sale                  Sale?             @relation(fields: [saleId], references: [id])
  saleInstallments      SaleInstallment[]
  transacoes            Transacao[]

  @@map("AccountRec")
  @@schema("erp")
}

model MetalReceivable {
  id             String                   @id @default(uuid())
  organizationId String
  saleId         String                   @unique
  pessoaId       String
  metalType      TipoMetal
  grams          Decimal                  @db.Decimal(10, 4)
  status         ReceivableStatus         @default(PENDENTE)
  dueDate        DateTime
  receivedAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  remainingGrams Decimal                  @db.Decimal(10, 4)
  payments       MetalReceivablePayment[]
  organization   Organization             @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa                   @relation(fields: [pessoaId], references: [id])
  sale           Sale                     @relation(fields: [saleId], references: [id])

  @@map("metal_receivables")
  @@schema("erp")
}

model MetalReceivablePayment {
  id                String          @id @default(uuid())
  organizationId    String
  metalReceivableId String
  paymentDate       DateTime
  paidAmountBRL     Decimal         @db.Decimal(10, 2)
  quotationUsed     Decimal         @db.Decimal(10, 2)
  paidAmountGrams   Decimal         @db.Decimal(10, 4)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  metalReceivable   MetalReceivable @relation(fields: [metalReceivableId], references: [id])
  organization      Organization    @relation(fields: [organizationId], references: [id])

  @@map("metal_receivable_payments")
  @@schema("erp")
}

model ContaContabil {
  id                     String                  @id @default(uuid())
  codigo                 String
  nome                   String
  tipo                   TipoContaContabilPrisma
  aceitaLancamento       Boolean                 @default(true)
  contaPaiId             String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  organizationId         String
  AccountPay             AccountPay[]
  contaPai               ContaContabil?          @relation("SubContas", fields: [contaPaiId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subContas              ContaContabil[]         @relation("SubContas")
  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contasCorrentes        ContaCorrente[]
  creditCardTransactions CreditCardTransaction[]
  cartoesDeCredito       CreditCard[]            @relation("CartaoParaContaPassivo")
  fornecedoresComDefault Fornecedor[]
  transacoes             Transacao[]

  @@unique([organizationId, codigo])
  @@map("contas_contabeis")
  @@schema("erp")
}

model ContaCorrente {
  id                 String            @id @default(uuid())
  nome               String
  numeroConta        String
  agencia            String?
  moeda              String            @default("BRL")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  organizationId     String
  limite             Decimal           @default(0) @db.Decimal(10, 2)
  initialBalanceBRL  Decimal           @default(0) @db.Decimal(10, 2)
  initialBalanceGold Decimal           @default(0) @db.Decimal(10, 4)
  type               ContaCorrenteType @default(BANCO)
  contaContabilId    String?
  isActive           Boolean           @default(true)
  nick               String?
  accountsRec        AccountRec[]
  contaContabil      ContaContabil?    @relation(fields: [contaContabilId], references: [id])
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transacoes         Transacao[]

  @@unique([organizationId, numeroConta])
  @@unique([organizationId, nick])
  @@map("contas_correntes")
  @@schema("erp")
}

model Transacao {
  id                  String              @id @default(uuid())
  tipo                TipoTransacaoPrisma
  valor               Decimal             @db.Decimal(10, 2)
  moeda               String
  descricao           String?
  dataHora            DateTime            @default(now())
  contaContabilId     String
  contaCorrenteId     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  fitId               String?
  organizationId      String
  goldAmount          Decimal?            @db.Decimal(10, 4)
  status              TransacaoStatus     @default(ATIVA)
  accountRecId        String?
  goldPrice           Decimal?            @db.Decimal(10, 2)
  linkedTransactionId String?             @unique
  fornecedorId        String?
  medias              Media[]             @relation("TransacaoToMedia")
  AccountPay          AccountPay?
  accountRec          AccountRec?         @relation(fields: [accountRecId], references: [id])
  contaContabil       ContaContabil       @relation(fields: [contaContabilId], references: [id])
  contaCorrente       ContaCorrente?      @relation(fields: [contaCorrenteId], references: [id], onDelete: NoAction)
  fornecedor          Fornecedor?         @relation(fields: [fornecedorId], references: [pessoaId])
  linkedTransaction   Transacao?          @relation("Transfer", fields: [linkedTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transfer            Transacao?          @relation("Transfer")
  organization        Organization        @relation(fields: [organizationId], references: [id])

  @@unique([contaCorrenteId, fitId])
  @@map("transacoes")
  @@schema("erp")
}

model CreditCard {
  id                     String                  @id @default(uuid())
  name                   String
  flag                   String
  closingDay             Int
  dueDate                Int
  contaContabilPassivoId String?
  organizationId         String
  bills                  CreditCardBill[]
  transactions           CreditCardTransaction[]
  contaContabilPassivo   ContaContabil?          @relation("CartaoParaContaPassivo", fields: [contaContabilPassivoId], references: [id])
  organization           Organization            @relation(fields: [organizationId], references: [id])

  @@map("credit_cards")
  @@schema("erp")
}

model CreditCardTransaction {
  id                 String          @id @default(uuid())
  creditCardId       String
  description        String
  amount             Decimal         @db.Decimal(10, 2)
  date               DateTime
  isInstallment      Boolean         @default(false)
  installments       Int?
  currentInstallment Int?
  creditCardBillId   String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  contaContabilId    String?
  fingerprint        String?         @unique
  contaContabil      ContaContabil?  @relation(fields: [contaContabilId], references: [id])
  creditCardBill     CreditCardBill? @relation(fields: [creditCardBillId], references: [id])
  creditCard         CreditCard      @relation(fields: [creditCardId], references: [id])

  @@map("credit_card_transactions")
  @@schema("erp")
}

model CreditCardBill {
  id             String                  @id @default(uuid())
  creditCardId   String
  name           String
  startDate      DateTime
  endDate        DateTime
  dueDate        DateTime
  totalAmount    Decimal                 @db.Decimal(10, 2)
  paid           Boolean                 @default(false)
  paidAt         DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  organizationId String
  creditCard     CreditCard              @relation(fields: [creditCardId], references: [id])
  organization   Organization            @relation(fields: [organizationId], references: [id])
  transactions   CreditCardTransaction[]

  @@map("credit_card_bills")
  @@schema("erp")
}

model XmlImportLog {
  id             String       @id @default(cuid())
  nfeKey         String       @unique
  createdAt      DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@schema("erp")
}

model LandingPage {
  id             String        @id @default(uuid())
  name           String        @unique @default("default")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  logoImageId    String?
  logoText       String?
  organizationId String?
  logoImage      Media?        @relation(fields: [logoImageId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])
  sections       Section[]

  @@map("LandingPage")
  @@schema("erp")
}

model Section {
  id            String      @id @default(uuid())
  landingPageId String
  order         Int
  type          String
  content       Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id])

  @@unique([landingPageId, order])
  @@map("Section")
  @@schema("erp")
}

model Media {
  id                     String               @id @default(uuid())
  filename               String               @unique
  mimetype               String
  size                   Int
  path                   String               @unique
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  organizationId         String?
  height                 Int?
  width                  Int?
  recoveryOrderId        String?
  analiseQuimicaId       String?
  transacaoId            String?
  chemicalReactionId     String?
  appearanceSettingsLogo AppearanceSettings[] @relation("AppearanceLogo")
  landingPageLogos       LandingPage[]
  analiseQuimica         AnaliseQuimica?      @relation(fields: [analiseQuimicaId], references: [id])
  chemicalReaction       chemical_reactions?  @relation(fields: [chemicalReactionId], references: [id])
  organization           Organization?        @relation(fields: [organizationId], references: [id])
  recoveryOrder          RecoveryOrder?       @relation(fields: [recoveryOrderId], references: [id])
  transacao              Transacao?           @relation("TransacaoToMedia", fields: [transacaoId], references: [id])

  @@map("Media")
  @@schema("erp")
}

model CreditCardFee {
  id             String       @id @default(uuid())
  organizationId String
  installments   Int
  feePercentage  Decimal      @db.Decimal(5, 2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, installments])
  @@map("credit_card_fees")
  @@schema("erp")
}

model Recuperacao {
  id                String                  @id @default(uuid())
  organizationId    String
  analiseQuimicaId  String
  status            StatusRecuperacaoPrisma @default(PENDENTE)
  dataInicio        DateTime                @default(now())
  dataFim           DateTime?
  descricaoProcesso String?
  volumeProcessado  Float?
  unidadeProcessada String?
  resultadoFinal    Float?
  unidadeResultado  String?
  observacoes       String?
  dataCriacao       DateTime                @default(now())
  dataAtualizacao   DateTime                @updatedAt
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  analiseQuimica    AnaliseQuimica          @relation(fields: [analiseQuimicaId], references: [id], onDelete: Cascade)
  organization      Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("recuperacoes")
  @@schema("erp")
}

model AnaliseQuimica {
  id                          String                     @id @default(uuid())
  organizationId              String
  clienteId                   String?
  numeroAnalise               String
  dataEntrada                 DateTime
  descricaoMaterial           String
  volumeOuPesoEntrada         Float
  unidadeEntrada              String
  resultadoAnaliseValor       Float?
  unidadeResultado            String?
  percentualQuebra            Float?
  taxaServicoPercentual       Float?
  teorRecuperavel             Float?
  auEstimadoBrutoGramas       Float?
  auEstimadoRecuperavelGramas Float?
  taxaServicoEmGramas         Float?
  auLiquidoParaClienteGramas  Float?
  status                      StatusAnaliseQuimicaPrisma @default(RECEBIDO)
  dataAnaliseConcluida        DateTime?
  dataAprovacaoCliente        DateTime?
  dataFinalizacaoRecuperacao  DateTime?
  observacoes                 String?
  ordemDeRecuperacaoId        String?
  dataCriacao                 DateTime                   @default(now())
  dataAtualizacao             DateTime                   @updatedAt
  metalType                   TipoMetal                  @default(AU)
  isWriteOff                  Boolean                    @default(false)
  media                       Media[]
  cliente                     Pessoa?                    @relation("PessoaAnalisesQuimicas", fields: [clienteId], references: [id], onDelete: Cascade)
  organization                Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metalCredit                 MetalCredit?
  recoveryOrderAsResidue      RecoveryOrder?             @relation("ResidueOfRecovery")
  recuperacoes                Recuperacao[]

  @@unique([organizationId, numeroAnalise])
  @@map("analises_quimicas")
  @@schema("erp")
}

model MetalCredit {
  id                 String            @id @default(uuid())
  organizationId     String
  clientId           String
  chemicalAnalysisId String?           @unique
  grams              Decimal           @db.Decimal(10, 4)
  date               DateTime          @default(now())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  metalType          TipoMetal         @default(AU)
  settledGrams       Decimal?          @default(0) @db.Decimal(10, 4)
  status             MetalCreditStatus @default(PENDING)
  chemicalAnalysis   AnaliseQuimica?   @relation(fields: [chemicalAnalysisId], references: [id])
  client             Pessoa            @relation(fields: [clientId], references: [id])
  organization       Organization      @relation(fields: [organizationId], references: [id])

  @@map("metal_credits")
  @@schema("erp")
}

model PurchaseOrder {
  id                   String              @id @default(uuid())
  organizationId       String
  fornecedorId         String
  orderNumber          String              @unique
  totalAmount          Decimal             @db.Decimal(10, 2)
  status               PurchaseOrderStatus @default(PENDING)
  orderDate            DateTime            @default(now())
  expectedDeliveryDate DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  paymentTermId        String?
  receivedAt           DateTime?
  accountsPay          AccountPay[]
  items                PurchaseOrderItem[]
  fornecedor           Fornecedor          @relation(fields: [fornecedorId], references: [pessoaId])
  organization         Organization        @relation(fields: [organizationId], references: [id])
  paymentTerm          PaymentTerm?        @relation(fields: [paymentTermId], references: [id])

  @@map("purchase_orders")
  @@schema("erp")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  productId       String?
  quantity        Float
  price           Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  rawMaterialId   String?
  unit            String?       @default("GRAMS")
  product         Product?      @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  rawMaterial     RawMaterial?  @relation(fields: [rawMaterialId], references: [id])

  @@map("purchase_order_items")
  @@schema("erp")
}

model RecoveryOrder {
  id                           String                    @id @default(uuid())
  organizationId               String
  chemicalAnalysisIds          String[]
  dataInicio                   DateTime                  @default(now())
  dataFim                      DateTime?
  observacoes                  String?
  status                       RecoveryOrderStatusPrisma @default(PENDENTE)
  auPuroRecuperadoGramas       Float?
  descricao                    String?
  residueAnalysisId            String?                   @unique
  residuoGramas                Float?
  resultadoProcessamentoGramas Float?
  teorFinal                    Float?
  totalBrutoEstimadoGramas     Float
  metalType                    TipoMetal                 @default(AU)
  orderNumber                  String                    @unique
  descricaoProcesso            String?
  dataCriacao                  DateTime                  @default(now()) @map("createdAt")
  dataAtualizacao              DateTime                  @updatedAt @map("updatedAt")
  commissionAmount             Decimal?                  @db.Decimal(10, 2)
  commissionPercentage         Decimal?                  @db.Decimal(5, 2)
  salespersonId                String?
  images                       Media[]
  rawMaterialsUsed             RawMaterialUsed[]
  organization                 Organization              @relation(fields: [organizationId], references: [id])
  residueAnalysis              AnaliseQuimica?           @relation("ResidueOfRecovery", fields: [residueAnalysisId], references: [id])
  salesperson                  Pessoa?                   @relation("SalespersonRecoveryOrders", fields: [salespersonId], references: [id])

  @@unique([organizationId, orderNumber])
  @@map("recovery_orders")
  @@schema("erp")
}

model RawMaterialUsed {
  id                 String              @id @default(uuid())
  organizationId     String
  rawMaterialId      String
  quantity           Float
  cost               Decimal             @db.Decimal(10, 2)
  goldEquivalentCost Decimal?            @db.Decimal(10, 4)
  recoveryOrderId    String?
  chemicalReactionId String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  chemicalReaction   chemical_reactions? @relation(fields: [chemicalReactionId], references: [id])
  organization       Organization        @relation(fields: [organizationId], references: [id])
  rawMaterial        RawMaterial         @relation(fields: [rawMaterialId], references: [id])
  recoveryOrder      RecoveryOrder?      @relation(fields: [recoveryOrderId], references: [id])

  @@map("raw_materials_used")
  @@schema("erp")
}

model MetalAccount {
  id             String              @id @default(uuid())
  personId       String
  type           TipoMetal
  organizationId String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  entries        MetalAccountEntry[]
  organization   Organization        @relation(fields: [organizationId], references: [id])
  person         Pessoa              @relation(fields: [personId], references: [id])

  @@unique([organizationId, personId, type])
  @@index([organizationId])
  @@map("metal_accounts")
  @@schema("erp")
}

model MetalAccountEntry {
  id             String       @id @default(uuid())
  metalAccountId String
  date           DateTime
  description    String
  grams          Decimal      @db.Decimal(10, 4)
  type           String
  sourceId       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  metalAccount   MetalAccount @relation(fields: [metalAccountId], references: [id])

  @@map("metal_account_entries")
  @@schema("erp")
}

model Quotation {
  id             String       @id @default(uuid())
  organizationId String
  metal          TipoMetal
  date           DateTime     @map("quotation_date") @db.Date
  buyPrice       Decimal      @db.Decimal(10, 2)
  sellPrice      Decimal      @db.Decimal(10, 2)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  tipoPagamento  String?
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, metal, date, tipoPagamento])
  @@map("quotations")
  @@schema("erp")
}

model LaborCostTableEntry {
  id                   String       @id @default(uuid())
  organizationId       String
  minGrams             Float
  maxGrams             Float?
  goldGramsCharged     Float
  commissionPercentage Decimal?     @db.Decimal(5, 2)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, minGrams])
  @@map("labor_cost_table_entries")
  @@schema("erp")
}

model OperationalCost {
  id                    String       @id @default(uuid())
  organizationId        String
  name                  String
  value                 Decimal      @db.Decimal(10, 2)
  type                  String
  appliesToProductGroup String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("operational_costs")
  @@schema("erp")
}

model chemical_reactions {
  id                            String                       @id @default(uuid())
  organizationId                String
  auUsedGrams                   Float
  notes                         String?
  outputProductGrams            Float
  status                        ChemicalReactionStatusPrisma @default(STARTED)
  reactionDate                  DateTime                     @default(now())
  createdAt                     DateTime                     @default(now())
  updatedAt                     DateTime                     @updatedAt
  productionBatchId             String?                      @unique
  inputBasketLeftoverGrams      Float?
  inputDistillateLeftoverGrams  Float?
  inputGoldGrams                Decimal                      @db.Decimal(10, 3)
  inputRawMaterialGrams         Float
  outputBasketLeftoverGrams     Float?
  outputDistillateLeftoverGrams Float?
  outputGoldGrams               Decimal                      @db.Decimal(10, 3)
  outputSilverGrams             Decimal?                     @db.Decimal(10, 3)
  outputProductId               String
  metalType                     TipoMetal                    @default(AU)
  reactionNumber                String                       @unique
  medias                        Media[]
  lots                          ChemicalReactionLot[]
  organization                  Organization                 @relation(fields: [organizationId], references: [id])
  outputProduct                 Product                      @relation(fields: [outputProductId], references: [id])
  productionBatch               InventoryLot?                @relation("ReactionToBatch", fields: [productionBatchId], references: [id])
  rawMaterialsUsed              RawMaterialUsed[]

  @@unique([organizationId, reactionNumber])
  @@map("chemical_reactions")
  @@schema("erp")
}

model pure_metal_lots {
  id                String                 @id @default(uuid())
  organizationId    String
  sourceType        String
  sourceId          String
  metalType         TipoMetal
  initialGrams      Float
  remainingGrams    Float
  purity            Float
  status            PureMetalLotStatus     @default(AVAILABLE)
  entryDate         DateTime               @default(now())
  notes             String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  saleId            String?
  lotNumber         String?                @unique
  description       String?
  chemicalReactions ChemicalReactionLot[]
  movements         PureMetalLotMovement[]
  Organization      Organization           @relation(fields: [organizationId], references: [id])
  sale              Sale?                  @relation(fields: [saleId], references: [id])

  @@map("pure_metal_lots")
  @@schema("erp")
}

model ChemicalReactionLot {
  chemicalReactionId String
  pureMetalLotId      String
  gramsToUse          Float
  chemicalReaction    chemical_reactions @relation(fields: [chemicalReactionId], references: [id])
  pureMetalLot        pure_metal_lots    @relation(fields: [pureMetalLotId], references: [id])

  @@id([chemicalReactionId, pureMetalLotId])
  @@map("chemical_reaction_lots")
  @@schema("erp")
}

model PureMetalLotMovement {
  id             String                   @id @default(uuid())
  organizationId String
  pureMetalLotId String
  type           PureMetalLotMovementType
  grams          Float
  date           DateTime                 @default(now())
  notes          String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organization   Organization             @relation(fields: [organizationId], references: [id])
  pureMetalLot   pure_metal_lots          @relation(fields: [pureMetalLotId], references: [id])

  @@map("pure_metal_lot_movements")
  @@schema("erp")
}

model ProductionBatchCounter {
  id              String   @id @default(uuid())
  organizationId  String   @unique
  lastBatchNumber Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("production_batch_counters")
  @@schema("erp")
}

model CrrCounter {
  id             String   @id @default(uuid())
  organizationId String   @unique
  lastCrrNumber  Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("crr_counters")
  @@schema("erp")
}

model EntityCounter {
  id             String     @id @default(uuid())
  organizationId String
  entityType     EntityType
  lastNumber     Int
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([organizationId, entityType])
  @@map("entity_counters")
  @@schema("erp")
}

model SaleAdjustment {
  id                     String       @id @default(uuid())
  saleId                 String       @unique
  organizationId         String
  paymentReceivedBRL     Decimal      @db.Decimal(14, 2)
  paymentQuotation       Decimal?     @db.Decimal(12, 2)
  paymentEquivalentGrams Decimal?     @db.Decimal(12, 4)
  saleExpectedGrams      Decimal?     @db.Decimal(12, 4)
  grossDiscrepancyGrams  Decimal?     @db.Decimal(12, 4)
  costsInBRL             Decimal      @db.Decimal(14, 2)
  costsInGrams           Decimal?     @db.Decimal(12, 4)
  netDiscrepancyGrams    Decimal?     @db.Decimal(12, 4)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  grossProfitBRL         Decimal?     @db.Decimal(14, 2)
  netProfitBRL           Decimal?     @db.Decimal(14, 2)
  otherCostsBRL          Decimal?     @db.Decimal(14, 2)
  totalCostBRL           Decimal?     @db.Decimal(14, 2)
  laborCostBRL           Decimal?     @db.Decimal(14, 2)
  laborCostGrams         Decimal?     @db.Decimal(12, 4)
  commissionBRL          Decimal?     @db.Decimal(14, 2)
  organization           Organization @relation(fields: [organizationId], references: [id])
  sale                   Sale         @relation(fields: [saleId], references: [id])

  @@map("sale_adjustments")
  @@schema("erp")
}

model MarketData {
  id              String       @id @default(uuid())
  date            DateTime     @db.Date
  usdPrice        Decimal      @db.Decimal(10, 4)
  goldTroyPrice   Decimal      @db.Decimal(10, 2)
  silverTroyPrice Decimal      @db.Decimal(10, 2)
  organizationId  String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, date])
  @@map("market_data")
  @@schema("erp")
}

model WhatsAppRoutine {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  trigger        String
  description    String?
  isActive       Boolean      @default(true)
  steps          Json
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@unique([organizationId, trigger])
  @@map("whatsapp_routines")
  @@schema("erp")
}

model MenuItem {
  id             String       @id @default(uuid())
  title          String
  href           String
  icon           String?
  order          Int
  parentId       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  disabled       Boolean?
  organization   Organization @relation(fields: [organizationId], references: [id])
  parent         MenuItem?    @relation("SubMenuItems", fields: [parentId], references: [id])
  subItems       MenuItem[]   @relation("SubMenuItems")

  @@unique([organizationId, title, parentId])
  @@map("MenuItem")
  @@schema("erp")
}

model AppearanceSettings {
  id             String       @id @default(uuid())
  organizationId String       @unique
  themeName      String?
  sidebarTheme   Json?
  logoImageId    String?
  logoText       String?
  logoImage      Media?       @relation("AppearanceLogo", fields: [logoImageId], references: [id])
  customTheme    Json? 
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation("AppearanceToOrganization", fields: [organizationId], references: [id])

  @@map("AppearanceSettings")
  @@schema("erp")
}

model Task {
  id             String       @id @default(uuid())
  title          String
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  createdById    String
  observation    String?
  createdBy      User         @relation(fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("tasks")
  @@schema("erp")
}

model Tutorial {
  id        String   @id
  title     String
  slug      String   @unique
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@map("Tutorial")
  @@schema("erp")
}

model ThemePreset {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  presetData     Json         
  isDefault      Boolean      @default(false) 
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("theme_presets")
  @@schema("erp")
}

enum TransacaoStatus {
  ATIVA
  AJUSTADA
  CANCELADA
  @@schema("erp")
}

enum PureMetalLotMovementType {
  ENTRY
  EXIT
  ADJUSTMENT
  @@schema("erp")
}

enum EntityType {
  RECOVERY_ORDER
  CHEMICAL_REACTION
  PURE_METAL_LOT
  @@schema("erp")
}

enum Role {
  USER
  ADMIN
  @@schema("erp")
}

enum PessoaType {
  FISICA
  JURIDICA
  @@schema("erp")
}

enum SaleInstallmentStatus {
  PENDING
  PAID
  OVERDUE
  PARTIALLY_PAID
  @@schema("erp")
}

enum ReceivableStatus {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
  PAGO_PARCIALMENTE
  @@schema("erp")
}

enum TipoContaContabilPrisma {
  ATIVO
  PASSIVO
  PATRIMONIO_LIQUIDO
  RECEITA
  DESPESA
  @@schema("erp")
}

enum TipoTransacaoPrisma {
  CREDITO
  DEBITO
  @@schema("erp")
}

enum ContaCorrenteType {
  BANCO
  FORNECEDOR_METAL
  EMPRESTIMO
  CLIENTE
  @@schema("erp")
}

enum StatusAnaliseQuimicaPrisma {
  RECEBIDO
  EM_ANALISE
  ANALISADO_AGUARDANDO_APROVACAO
  APROVADO_PARA_RECUPERACAO
  RECUSADO_PELO_CLIENTE
  EM_RECUPERACAO
  FINALIZADO_RECUPERADO
  CANCELADO
  RESIDUO
  @@schema("erp")
}

enum StatusRecuperacaoPrisma {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
  @@schema("erp")
}

enum PurchaseOrderStatus {
  PENDING
  RECEIVED
  CANCELED
  @@schema("erp")
}

enum RecoveryOrderStatusPrisma {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
  AGUARDANDO_RESULTADO
  AGUARDANDO_TEOR
  @@schema("erp")
}

enum TipoMetal {
  AU
  AG
  RH
  @@schema("erp")
}

enum PureMetalLotStatus {
  AVAILABLE
  USED
  PARTIALLY_USED
  @@schema("erp")
}

enum ChemicalReactionStatusPrisma {
  STARTED
  PROCESSING
  PENDING_PURITY
  PENDING_PURITY_ADJUSTMENT
  COMPLETED
  CANCELED
  @@schema("erp")
}

enum ReactionLeftoverType {
  BASKET
  DISTILLATE
  @@schema("erp")
}

enum ContaMetalType {
  CLIENTE
  FORNECEDOR
  INTERNA
  EMPRESTIMO
  @@schema("erp")
}

enum SaleStatus {
  PENDENTE
  CONFIRMADO
  A_SEPARAR
  FINALIZADO
  CANCELADO
  SEPARADO
  PAGO_PARCIALMENTE
  @@schema("erp")
}

enum SaleAdjustmentCalcMethod {
  QUANTITY_BASED
  COST_BASED
  @@schema("erp")
}

enum StockUnit {
  GRAMS
  KILOGRAMS
  LITERS
  UNITS
  @@schema("erp")
}

enum StockMovementType {
  ENTRY
  EXIT
  SALE
  PURCHASE
  ADJUSTMENT
  @@schema("erp")
}

enum MetalCreditStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELED
  @@schema("erp")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  @@schema("erp")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  @@schema("erp")
}