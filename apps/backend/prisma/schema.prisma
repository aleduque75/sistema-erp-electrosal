generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                      String                   @id @default(uuid())
  name                    String
  absorbCreditCardFee     Boolean                  @default(false)
  creditCardReceiveDays   Int?                     @default(30)
  accountsRec             AccountRec[]
  landingPages            LandingPage[]
  media                   Media[]
  products                Product[]
  sales                   Sale[]
  stockMovements          StockMovement[]
  users                   User[]
  xmlImportLogs           XmlImportLog[]
  accountsPay             AccountPay[]
  analisesQuimicas        AnaliseQuimica[]
  chemical_reactions      chemical_reactions[]
  clients                 Client[]
  contasContabeis         ContaContabil[]
  contasCorrentes         ContaCorrente[]
  creditCardBills         CreditCardBill[]
  CreditCardFee           CreditCardFee[]
  creditCards             CreditCard[]
  fornecedores            Fornecedor[]
  funcionarios            Funcionario[]
  inventoryLots           InventoryLot[]
  laborCostTableEntries   LaborCostTableEntry[]
  metalAccounts           MetalAccount[]
  metalCredits            MetalCredit[]
  metalReceivablePayments MetalReceivablePayment[]
  metalReceivables        MetalReceivable[]
  operationalCosts        OperationalCost[]
  paymentTerms            PaymentTerm[]
  pessoas                 Pessoa[]
  productGroups           ProductGroup[]
  purchaseOrders          PurchaseOrder[]
  pure_metal_lots         pure_metal_lots[]
  quotations              Quotation[]
  recoveryOrders          RecoveryOrder[]
  recuperacoes            Recuperacao[]
  saleAdjustments         SaleAdjustment[]
  rawMaterials            RawMaterial[]
  rawMaterialsUsed        RawMaterialUsed[]
  transacoes              Transacao[]
  pureMetalLotMovements   PureMetalLotMovement[]
}

model User {
  id             String        @id @default(uuid())
  email          String        @unique
  password       String
  name           String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  role           Role          @default(USER)
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  settings       UserSettings?
}

model UserSettings {
  id                          String  @id @default(uuid())
  userId                      String  @unique
  defaultReceitaContaId       String?
  defaultCaixaContaId         String?
  defaultDespesaContaId       String?
  metalStockAccountId         String?
  productionCostAccountId     String?
  metalCreditPayableAccountId String?
  user                        User    @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

model Pessoa {
  id                          String            @id @default(uuid())
  organizationId              String
  type                        PessoaType
  name                        String
  razaoSocial                 String?
  email                       String?           @unique
  phone                       String?
  cpf                         String?           @unique
  cnpj                        String?           @unique
  birthDate                   DateTime?
  gender                      String?
  cep                         String?
  logradouro                  String?
  numero                      String?
  complemento                 String?
  bairro                      String?
  cidade                      String?
  uf                          String?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  externalId                  String?           @unique
  sales                       Sale[]
  analisesQuimicasComoCliente AnaliseQuimica[]  @relation("PessoaAnalisesQuimicas")
  client                      Client?
  fornecedor                  Fornecedor?
  funcionario                 Funcionario?
  metalAccounts               MetalAccount[]
  metalCredits                MetalCredit[]
  metalReceivables            MetalReceivable[]
  organization                Organization      @relation(fields: [organizationId], references: [id])

  @@map("pessoas")
}

model Client {
  pessoaId       String       @id
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa       @relation(fields: [pessoaId], references: [id], onDelete: Cascade)

  @@map("clients")
}

model Fornecedor {
  pessoaId               String          @id
  organizationId         String
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  defaultContaContabilId String?
  organization           Organization    @relation(fields: [organizationId], references: [id])
  pessoa                 Pessoa          @relation(fields: [pessoaId], references: [id], onDelete: Cascade)
  purchaseOrders         PurchaseOrder[]
  accountsPay            AccountPay[]
  transacoes             Transacao[]
  defaultContaContabil   ContaContabil?  @relation(fields: [defaultContaContabilId], references: [id])

  @@map("fornecedores")
}

model Funcionario {
  pessoaId       String       @id
  organizationId String
  hireDate       DateTime
  position       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa       @relation(fields: [pessoaId], references: [id], onDelete: Cascade)

  @@map("funcionarios")
}

model Product {
  id                        String               @id @default(uuid())
  name                      String
  description               String?
  price                     Decimal              @db.Decimal(10, 2)
  stock                     Float?
  stockUnit                 StockUnit            @default(GRAMS)
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  organizationId            String
  costPrice                 Decimal?             @db.Decimal(10, 2)
  productGroupId            String?
  goldValue                 Float?
  externalId                String?              @unique
  organization              Organization         @relation(fields: [organizationId], references: [id])
  productGroup              ProductGroup?        @relation(fields: [productGroupId], references: [id])
  saleItems                 SaleItem[]
  stockMovements            StockMovement[]
  inventoryLots             InventoryLot[]
  purchaseOrderItems        PurchaseOrderItem[]
  chemicalReactionsAsOutput chemical_reactions[]
}

model RawMaterial {
  id                 String              @id @default(uuid())
  organizationId     String
  name               String
  description        String?
  unit               StockUnit           @default(GRAMS)
  cost               Decimal             @db.Decimal(10, 2)
  isForResale        Boolean             @default(false)
  stock              Float?              @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organization       Organization        @relation(fields: [organizationId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  rawMaterialsUsed   RawMaterialUsed[]

  @@map("raw_materials")
}

model ProductGroup {
  id                     String                   @id @default(uuid())
  organizationId         String
  name                   String
  description            String?
  commissionPercentage   Decimal?                 @db.Decimal(5, 2)
  isReactionProductGroup Boolean                  @default(false)
  adjustmentCalcMethod   SaleAdjustmentCalcMethod @default(QUANTITY_BASED)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  products               Product[]
  organization           Organization             @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("product_groups")
}

model InventoryLot {
  id                  String               @id @default(uuid())
  organizationId      String
  productId           String
  batchNumber         String?              @unique
  costPrice           Decimal              @db.Decimal(10, 2)
  quantity            Float
  remainingQuantity   Float
  sourceType          String
  sourceId            String
  notes               String?
  receivedDate        DateTime             @default(now())
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  stockMovements      StockMovement[]
  reaction            chemical_reactions?  @relation("ReactionToBatch")
  organization        Organization         @relation(fields: [organizationId], references: [id])
  product             Product              @relation(fields: [productId], references: [id])
  saleItemLots        SaleItemLot[]

  @@map("inventory_lots")
}

model StockMovement {
  id             String        @id @default(uuid())
  productId      String
  inventoryLotId String?
  type           String
  quantity       Float
  sourceDocument String?
  createdAt      DateTime      @default(now())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  product        Product       @relation(fields: [productId], references: [id])
  inventoryLot   InventoryLot? @relation(fields: [inventoryLotId], references: [id])
}

model Sale {
  id                String            @id @default(uuid())
  orderNumber       Int               @unique
  totalAmount       Decimal           @db.Decimal(14, 2)
  feeAmount         Decimal?          @db.Decimal(10, 2)
  netAmount         Decimal?          @db.Decimal(14, 2)
  paymentMethod     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  organizationId    String
  paymentTermId     String?
  pessoaId          String
  goldPrice         Decimal?          @db.Decimal(10, 2)
  goldValue         Decimal?          @db.Decimal(10, 4)
  totalCost         Decimal?          @db.Decimal(14, 2)
  commissionAmount  Decimal?          @db.Decimal(10, 2)
  commissionDetails Json?
  externalId        String?           @unique
  status            SaleStatus        @default(PENDENTE)
  shippingCost      Decimal?          @db.Decimal(10, 2)
  readyForPayment   Boolean           @default(false)
  accountsRec       AccountRec[]
  organization      Organization      @relation(fields: [organizationId], references: [id])
  paymentTerm       PaymentTerm?      @relation(fields: [paymentTermId], references: [id])
  pessoa            Pessoa            @relation(fields: [pessoaId], references: [id])
  saleItems         SaleItem[]
  metalReceivable   MetalReceivable?
  pureMetalLots     pure_metal_lots[]
  adjustment        SaleAdjustment?
  installments      SaleInstallment[]
}

model PaymentTerm {
  id               String          @id @default(uuid())
  organizationId   String
  name             String
  description      String?
  installmentsDays Int[]
  interestRate     Decimal?        @db.Decimal(5, 2)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  sales            Sale[]
  organization     Organization    @relation(fields: [organizationId], references: [id])
  purchaseOrders   PurchaseOrder[]

  @@unique([organizationId, name])
  @@map("payment_terms")
}

model SaleItem {

  id              String        @id @default(uuid())

  saleId          String

  productId       String

  quantity        Float

  price           Decimal       @db.Decimal(10, 2)

  createdAt       DateTime      @default(now())

  updatedAt       DateTime      @updatedAt

  costPriceAtSale Decimal       @db.Decimal(10, 2)

  laborPercentage Decimal?      @db.Decimal(5, 2)

  externalId      String?       @unique

  product         Product       @relation(fields: [productId], references: [id])

  sale            Sale          @relation(fields: [saleId], references: [id])

  saleItemLots    SaleItemLot[]

}



model SaleItemLot {
  id             String       @id @default(uuid())
  saleItemId     String
  inventoryLotId String
  quantity       Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  saleItem       SaleItem     @relation(fields: [saleItemId], references: [id])
  inventoryLot   InventoryLot @relation(fields: [inventoryLotId], references: [id])

  @@unique([saleItemId, inventoryLotId])
  @@map("sale_item_lots")
}

model SaleInstallment {
  id                String                @id @default(uuid())
  saleId            String
  amount            Decimal
  dueDate           DateTime
  paidAt            DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  installmentNumber Int
  status            SaleInstallmentStatus
  accountRecId      String?
  accountRec        AccountRec?           @relation(fields: [accountRecId], references: [id])
  sale              Sale                  @relation(fields: [saleId], references: [id])

  @@map("sale_installments")
}

model AccountPay {
  id                String         @id @default(uuid())
  description       String
  amount            Decimal        @db.Decimal(10, 2)
  dueDate           DateTime
  paid              Boolean        @default(false)
  paidAt            DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  installmentNumber Int?
  isInstallment     Boolean?
  totalInstallments Int?
  contaContabilId   String?
  organizationId    String
  transacaoId       String?        @unique
  purchaseOrderId   String?
  fornecedorId      String?
  originalAccountId String?
  contaContabil     ContaContabil? @relation(fields: [contaContabilId], references: [id])
  organization      Organization   @relation(fields: [organizationId], references: [id])
  transacao         Transacao?     @relation(fields: [transacaoId], references: [id])
  purchaseOrder     PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  fornecedor        Fornecedor?    @relation(fields: [fornecedorId], references: [pessoaId])
  originalAccount   AccountPay?    @relation("SplitFrom", fields: [originalAccountId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  splitAccounts     AccountPay[]   @relation("SplitFrom")

  @@map("accounts_pay")
}

model AccountRec {
  id                    String            @id @default(uuid())
  saleId                String?
  description           String
  amount                Decimal           @db.Decimal(10, 2)
  dueDate               DateTime
  received              Boolean           @default(false)
  receivedAt            DateTime?
  amountPaid            Decimal           @db.Decimal(10, 2) @default(0)
  goldAmount            Decimal?          @db.Decimal(12, 4)
  goldAmountPaid        Decimal?          @db.Decimal(12, 4) @default(0)
  doNotUpdateSaleStatus Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  contaCorrenteId       String?
  organizationId        String
  transacaoId_old       String?           @unique @map("transacaoId")
  externalId            String?           @unique
  contaCorrente         ContaCorrente?    @relation(fields: [contaCorrenteId], references: [id])
  organization          Organization      @relation(fields: [organizationId], references: [id])
  sale                  Sale?             @relation(fields: [saleId], references: [id])
  saleInstallments      SaleInstallment[]
  transacoes            Transacao[]
}

model MetalReceivable {
  id             String                   @id @default(uuid())
  organizationId String
  saleId         String                   @unique
  pessoaId       String
  metalType      TipoMetal
  grams          Decimal                  @db.Decimal(10, 4)
  status         ReceivableStatus         @default(PENDENTE)
  dueDate        DateTime
  receivedAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  remainingGrams Decimal                  @db.Decimal(10, 4)
  payments       MetalReceivablePayment[]
  organization   Organization             @relation(fields: [organizationId], references: [id])
  pessoa         Pessoa                   @relation(fields: [pessoaId], references: [id])
  sale           Sale                     @relation(fields: [saleId], references: [id])

  @@map("metal_receivables")
}

model MetalReceivablePayment {
  id                String          @id @default(uuid())
  organizationId    String
  metalReceivableId String
  paymentDate       DateTime
  paidAmountBRL     Decimal         @db.Decimal(10, 2)
  quotationUsed     Decimal         @db.Decimal(10, 2)
  paidAmountGrams   Decimal         @db.Decimal(10, 4)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  metalReceivable   MetalReceivable @relation(fields: [metalReceivableId], references: [id])
  organization      Organization    @relation(fields: [organizationId], references: [id])

  @@map("metal_receivable_payments")
}

model ContaContabil {
  id                     String                  @id @default(uuid())
  codigo                 String
  nome                   String
  tipo                   TipoContaContabilPrisma
  aceitaLancamento       Boolean                 @default(true)
  contaPaiId             String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  organizationId         String
  AccountPay             AccountPay[]
  contaPai               ContaContabil?          @relation("SubContas", fields: [contaPaiId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subContas              ContaContabil[]         @relation("SubContas")
  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creditCardTransactions CreditCardTransaction[]
  cartoesDeCredito       CreditCard[]            @relation("CartaoParaContaPassivo")
  transacoes             Transacao[]
  fornecedoresComDefault Fornecedor[]
  contasCorrentes        ContaCorrente[]

  @@unique([organizationId, codigo])
  @@map("contas_contabeis")
}

model ContaCorrente {
  id                 String            @id @default(uuid())
  nome               String
  numeroConta        String
  agencia            String?
  moeda              String            @default("BRL")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  organizationId     String
  limite             Decimal           @default(0) @db.Decimal(10, 2)
  initialBalanceBRL  Decimal           @default(0) @db.Decimal(10, 2)
  initialBalanceGold Decimal           @default(0) @db.Decimal(10, 4)
  type               ContaCorrenteType @default(BANCO)
  contaContabilId    String?
  accountsRec        AccountRec[]
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contaContabil      ContaContabil?    @relation(fields: [contaContabilId], references: [id])
  transacoes         Transacao[]

  @@unique([organizationId, numeroConta])
  @@map("contas_correntes")
}

model Transacao {
  id                  String              @id @default(uuid())
  tipo                TipoTransacaoPrisma
  valor               Decimal             @db.Decimal(10, 2)
  moeda               String
  descricao           String?
  dataHora            DateTime            @default(now())
  contaContabilId     String
  contaCorrenteId     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  fitId               String?
  organizationId      String
  goldAmount          Decimal?            @db.Decimal(10, 4)
  goldPrice           Decimal?            @db.Decimal(10, 2)
  accountRecId        String?
  fornecedorId        String?
  AccountPay          AccountPay?
  contaContabil       ContaContabil       @relation(fields: [contaContabilId], references: [id])
  contaCorrente       ContaCorrente?      @relation(fields: [contaCorrenteId], references: [id], onDelete: NoAction)
  organization        Organization        @relation(fields: [organizationId], references: [id])
  status              TransacaoStatus     @default(ATIVA)
  accountRec          AccountRec?         @relation(fields: [accountRecId], references: [id])
  fornecedor          Fornecedor?         @relation(fields: [fornecedorId], references: [pessoaId])
  medias              Media[]             @relation("TransacaoToMedia")
  linkedTransactionId String?             @unique
  linkedTransaction   Transacao?          @relation("Transfer", fields: [linkedTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transfer            Transacao?          @relation("Transfer")

  @@unique([contaCorrenteId, fitId])
  @@map("transacoes")
}

enum TransacaoStatus {
  ATIVA
  AJUSTADA
  CANCELADA
}

model CreditCard {
  id                     String                  @id @default(uuid())
  name                   String
  flag                   String
  closingDay             Int
  dueDate                Int
  contaContabilPassivoId String?
  organizationId         String
  bills                  CreditCardBill[]
  transactions           CreditCardTransaction[]
  contaContabilPassivo   ContaContabil?          @relation("CartaoParaContaPassivo", fields: [contaContabilPassivoId], references: [id])
  organization           Organization            @relation(fields: [organizationId], references: [id])

  @@map("credit_cards")
}

model CreditCardTransaction {
  id                 String          @id @default(uuid())
  creditCardId       String
  description        String
  amount             Decimal         @db.Decimal(10, 2)
  date               DateTime
  isInstallment      Boolean         @default(false)
  installments       Int?
  currentInstallment Int?
  creditCardBillId   String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  contaContabilId    String?
  fingerprint        String?         @unique
  contaContabil      ContaContabil?  @relation(fields: [contaContabilId], references: [id])
  creditCardBill     CreditCardBill? @relation(fields: [creditCardBillId], references: [id])
  creditCard         CreditCard      @relation(fields: [creditCardId], references: [id])

  @@map("credit_card_transactions")
}

model CreditCardBill {
  id             String                  @id @default(uuid())
  creditCardId   String
  name           String
  startDate      DateTime
  endDate        DateTime
  dueDate        DateTime
  totalAmount    Decimal                 @db.Decimal(10, 2)
  paid           Boolean                 @default(false)
  paidAt         DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  organizationId String
  creditCard     CreditCard              @relation(fields: [creditCardId], references: [id])
  organization   Organization            @relation(fields: [organizationId], references: [id])
  transactions   CreditCardTransaction[]

  @@map("credit_card_bills")
}

model XmlImportLog {
  id             String       @id @default(cuid())
  nfeKey         String       @unique
  createdAt      DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model LandingPage {
  id              String        @id @default(uuid())
  name            String        @unique @default("default")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  logoImageId     String?
  logoText        String?
  organizationId  String?
  customThemeName String?
  logoImage       Media?        @relation(fields: [logoImageId], references: [id])
  Organization    Organization? @relation(fields: [organizationId], references: [id])
  sections        Section[]
}

model Section {
  id            String      @id @default(uuid())
  landingPageId String
  order         Int
  type          String
  content       Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id])

  @@unique([landingPageId, order])
}

model Media {
  id                 String              @id @default(uuid())
  filename           String              @unique
  mimetype           String
  size               Int
  path               String              @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organizationId     String?
  height             Int?
  width              Int?
  landingPageLogos   LandingPage[]
  recoveryOrderId    String?
  recoveryOrder      RecoveryOrder?      @relation(fields: [recoveryOrderId], references: [id])
  analiseQuimicaId   String?
  analiseQuimica     AnaliseQuimica?     @relation(fields: [analiseQuimicaId], references: [id])
  chemicalReactionId String?
  chemicalReaction   chemical_reactions? @relation(fields: [chemicalReactionId], references: [id])
  organization       Organization?       @relation(fields: [organizationId], references: [id])
  transacaoId        String?
  transacao          Transacao?          @relation("TransacaoToMedia", fields: [transacaoId], references: [id])
}

model CreditCardFee {
  id             String       @id @default(uuid())
  organizationId String
  installments   Int
  feePercentage  Decimal      @db.Decimal(5, 2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, installments])
  @@map("credit_card_fees")
}

model Recuperacao {
  id                String                  @id @default(uuid())
  organizationId    String
  analiseQuimicaId  String
  status            StatusRecuperacaoPrisma @default(PENDENTE)
  dataInicio        DateTime                @default(now())
  dataFim           DateTime?
  descricaoProcesso String?
  volumeProcessado  Float?
  unidadeProcessada String?
  resultadoFinal    Float?
  unidadeResultado  String?
  observacoes       String?
  dataCriacao       DateTime                @default(now())
  dataAtualizacao   DateTime                @updatedAt
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  analiseQuimica    AnaliseQuimica          @relation(fields: [analiseQuimicaId], references: [id], onDelete: Cascade)
  organization      Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("recuperacoes")
}

model AnaliseQuimica {
  id                          String                     @id @default(uuid())
  organizationId              String
  metalType                   TipoMetal                  @default(AU)
  clienteId                   String?
  numeroAnalise               String
  dataEntrada                 DateTime
  descricaoMaterial           String
  volumeOuPesoEntrada         Float
  unidadeEntrada              String
  resultadoAnaliseValor       Float?
  unidadeResultado            String?
  percentualQuebra            Float?
  taxaServicoPercentual       Float?
  teorRecuperavel             Float?
  auEstimadoBrutoGramas       Float?
  auEstimadoRecuperavelGramas Float?
  taxaServicoEmGramas         Float?
  auLiquidoParaClienteGramas  Float?
  status                      StatusAnaliseQuimicaPrisma @default(RECEBIDO)
  dataAnaliseConcluida        DateTime?
  dataAprovacaoCliente        DateTime?
  dataFinalizacaoRecuperacao  DateTime?
  observacoes                 String?
  ordemDeRecuperacaoId        String?
  dataCriacao                 DateTime                   @default(now())
  dataAtualizacao             DateTime                   @updatedAt
  cliente                     Pessoa?                    @relation("PessoaAnalisesQuimicas", fields: [clienteId], references: [id], onDelete: Cascade)
  organization                Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metalCredit                 MetalCredit?
  recoveryOrderAsResidue      RecoveryOrder?             @relation("ResidueOfRecovery")
  recuperacoes                Recuperacao[]
  media                       Media[]

  @@unique([organizationId, numeroAnalise])
  @@map("analises_quimicas")
}

model MetalCredit {
  id                 String            @id @default(uuid())
  organizationId     String
  clientId           String
  chemicalAnalysisId String            @unique
  metalType          TipoMetal         @default(AU)
  grams              Decimal           @db.Decimal(10, 4)
  date               DateTime          @default(now())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  status             MetalCreditStatus @default(PENDING)
  settledGrams       Decimal?          @db.Decimal(10, 4) @default(0)
  chemicalAnalysis   AnaliseQuimica    @relation(fields: [chemicalAnalysisId], references: [id])
  client             Pessoa            @relation(fields: [clientId], references: [id])
  organization       Organization      @relation(fields: [organizationId], references: [id])

  @@map("metal_credits")
}

model PurchaseOrder {
  id                   String              @id @default(uuid())
  organizationId       String
  fornecedorId         String
  orderNumber          String              @unique
  totalAmount          Decimal             @db.Decimal(10, 2)
  status               PurchaseOrderStatus @default(PENDING)
  orderDate            DateTime            @default(now())
  receivedAt           DateTime?
  expectedDeliveryDate DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  paymentTermId        String?
  items                PurchaseOrderItem[]
  fornecedor           Fornecedor          @relation(fields: [fornecedorId], references: [pessoaId])
  organization         Organization        @relation(fields: [organizationId], references: [id])
  paymentTerm          PaymentTerm?        @relation(fields: [paymentTermId], references: [id])
  accountsPay          AccountPay[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  productId       String?
  rawMaterialId   String?
  quantity        Float
  price           Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  product         Product?      @relation(fields: [productId], references: [id])
  rawMaterial     RawMaterial?  @relation(fields: [rawMaterialId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@map("purchase_order_items")
}

model RecoveryOrder {
  id                           String                    @id @default(uuid())
  organizationId               String
  orderNumber                  String                    @unique
  metalType                    TipoMetal                 @default(AU)
  chemicalAnalysisIds          String[]
  dataInicio                   DateTime                  @default(now())
  dataFim                      DateTime?
  descricaoProcesso            String?
  observacoes                  String?
  dataCriacao                  DateTime                  @default(now()) @map("createdAt")
  dataAtualizacao              DateTime                  @updatedAt @map("updatedAt")
  status                       RecoveryOrderStatusPrisma @default(PENDENTE)
  auPuroRecuperadoGramas       Float?
  descricao                    String?
  residueAnalysisId            String?                   @unique
  residuoGramas                Float?
  resultadoProcessamentoGramas Float?
  teorFinal                    Float?
  totalBrutoEstimadoGramas     Float
  organization                 Organization              @relation(fields: [organizationId], references: [id])
  residueAnalysis              AnaliseQuimica?           @relation("ResidueOfRecovery", fields: [residueAnalysisId], references: [id])
  rawMaterialsUsed             RawMaterialUsed[]
  images                       Media[]

  @@unique([organizationId, orderNumber])
  @@map("recovery_orders")
}

model RawMaterialUsed {
  id                 String              @id @default(uuid())
  organizationId     String
  rawMaterialId      String
  quantity           Float
  cost               Decimal             @db.Decimal(10, 2)
  goldEquivalentCost Decimal?            @db.Decimal(10, 4)
  recoveryOrderId    String?
  chemicalReactionId String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organization       Organization        @relation(fields: [organizationId], references: [id])
  rawMaterial        RawMaterial         @relation(fields: [rawMaterialId], references: [id])
  recoveryOrder      RecoveryOrder?      @relation(fields: [recoveryOrderId], references: [id])
  chemicalReaction   chemical_reactions? @relation(fields: [chemicalReactionId], references: [id])

  @@map("raw_materials_used")
}

model MetalAccount {
  id             String              @id @default(uuid())
  personId       String
  type           TipoMetal
  organizationId String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  entries        MetalAccountEntry[]
  organization   Organization        @relation(fields: [organizationId], references: [id])
  person         Pessoa              @relation(fields: [personId], references: [id])

  @@unique([organizationId, personId, type])
  @@index([organizationId])
  @@map("metal_accounts")
}

model MetalAccountEntry {
  id             String       @id @default(uuid())
  metalAccountId String
  date           DateTime
  description    String
  grams          Decimal      @db.Decimal(10, 4)
  type           String
  sourceId       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  metalAccount   MetalAccount @relation(fields: [metalAccountId], references: [id])

  @@map("metal_account_entries")
}

model Quotation {
  id            String       @id @default(uuid())
  organizationId String
  metal         TipoMetal
  date          DateTime     @map("quotation_date") @db.Date
  buyPrice      Decimal      @db.Decimal(10, 2)
  sellPrice     Decimal      @db.Decimal(10, 2)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  tipoPagamento String?
  organization  Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, metal, date, tipoPagamento])
  @@map("quotations")
}

model LaborCostTableEntry {
  id                   String       @id @default(uuid())
  organizationId       String
  minGrams             Float
  maxGrams             Float?
  goldGramsCharged     Float
  commissionPercentage Decimal?     @db.Decimal(5, 2)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, minGrams])
  @@map("labor_cost_table_entries")
}

model OperationalCost {
  id                    String       @id @default(uuid())
  organizationId        String
  name                  String
  value                 Decimal      @db.Decimal(10, 2)
  type                  String
  appliesToProductGroup String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("operational_costs")
}

model chemical_reactions {
  id                            String                       @id @default(uuid())
  organizationId                String
  reactionNumber                String                       @unique
  metalType                     TipoMetal                    @default(AU)
  auUsedGrams                   Float
  notes                         String?
  outputProductGrams            Float
  status                        ChemicalReactionStatusPrisma @default(STARTED)
  reactionDate                  DateTime                     @default(now())
  createdAt                     DateTime                     @default(now())
  updatedAt                     DateTime                     @updatedAt
  productionBatchId             String?                      @unique
  inputBasketLeftoverGrams      Float?
  inputDistillateLeftoverGrams  Float?
  inputGoldGrams                Decimal                      @db.Decimal(10, 3)
  inputRawMaterialGrams         Float
  outputBasketLeftoverGrams     Float?
  outputDistillateLeftoverGrams Float?
  outputGoldGrams               Decimal                      @db.Decimal(10, 3)
  outputSilverGrams             Decimal?                     @db.Decimal(10, 3)
  outputProductId               String
  organization                  Organization                 @relation(fields: [organizationId], references: [id])
  outputProduct                 Product                      @relation(fields: [outputProductId], references: [id])
  productionBatch               InventoryLot?                @relation("ReactionToBatch", fields: [productionBatchId], references: [id])
  lots                          ChemicalReactionLot[]
  rawMaterialsUsed              RawMaterialUsed[]
  medias                        Media[]

  @@unique([organizationId, reactionNumber])
  @@map("chemical_reactions")
}

model pure_metal_lots {
  id                 String               @id @default(uuid())
  lotNumber          String?              @unique
  organizationId     String
  sourceType         String
  sourceId           String
  description        String?
  metalType          TipoMetal
  initialGrams       Float
  remainingGrams     Float
  purity             Float
  status             PureMetalLotStatus   @default(AVAILABLE)
  entryDate          DateTime             @default(now())
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  saleId             String?
  Organization       Organization         @relation(fields: [organizationId], references: [id])
  sale               Sale?                @relation(fields: [saleId], references: [id])
  chemicalReactions  ChemicalReactionLot[]
  movements          PureMetalLotMovement[]
}

model ChemicalReactionLot {
  chemicalReactionId String
  pureMetalLotId     String
  gramsToUse         Float
  chemicalReaction   chemical_reactions @relation(fields: [chemicalReactionId], references: [id])
  pureMetalLot       pure_metal_lots    @relation(fields: [pureMetalLotId], references: [id])

  @@id([chemicalReactionId, pureMetalLotId])
  @@map("chemical_reaction_lots")
}

model PureMetalLotMovement {
  id             String                   @id @default(uuid())
  organizationId String
  pureMetalLotId String
  type           PureMetalLotMovementType
  grams          Float
  date           DateTime                 @default(now())
  notes          String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organization   Organization             @relation(fields: [organizationId], references: [id])
  pureMetalLot   pure_metal_lots          @relation(fields: [pureMetalLotId], references: [id])

  @@map("pure_metal_lot_movements")
}

enum PureMetalLotMovementType {
  ENTRY
  EXIT
  ADJUSTMENT
}

model ProductionBatchCounter {
  id              String   @id @default(uuid())
  organizationId  String   @unique
  lastBatchNumber Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("production_batch_counters")
}

model CrrCounter {
  id              String   @id @default(uuid())
  organizationId  String   @unique
  lastCrrNumber   Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("crr_counters")
}

model EntityCounter {
  id             String     @id @default(uuid())
  organizationId String
  entityType     EntityType
  lastNumber     Int
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([organizationId, entityType])
  @@map("entity_counters")
}

enum EntityType {
  RECOVERY_ORDER
  CHEMICAL_REACTION
  PURE_METAL_LOT
}

model SaleAdjustment {
  id                     String       @id @default(uuid())
  saleId                 String       @unique
  organizationId         String
  paymentReceivedBRL     Decimal      @db.Decimal(14, 2)
  paymentQuotation       Decimal?     @db.Decimal(12, 2)
  paymentEquivalentGrams Decimal?     @db.Decimal(12, 4)
  saleExpectedGrams      Decimal?     @db.Decimal(12, 4)
  grossDiscrepancyGrams  Decimal?     @db.Decimal(12, 4)
  costsInBRL             Decimal      @db.Decimal(14, 2)
  costsInGrams           Decimal?     @db.Decimal(12, 4)
  laborCostGrams         Decimal?     @db.Decimal(12, 4)
  laborCostBRL           Decimal?     @db.Decimal(14, 2)
  netDiscrepancyGrams    Decimal?     @db.Decimal(12, 4)
  totalCostBRL           Decimal?     @db.Decimal(14, 2)
  grossProfitBRL         Decimal?     @db.Decimal(14, 2)
  otherCostsBRL          Decimal?     @db.Decimal(14, 2)
  netProfitBRL           Decimal?     @db.Decimal(14, 2)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  organization           Organization @relation(fields: [organizationId], references: [id])
  sale                   Sale         @relation(fields: [saleId], references: [id])

  @@map("sale_adjustments")
}

enum Role {
  USER
  ADMIN
}

enum PessoaType {
  FISICA
  JURIDICA
}

enum SaleInstallmentStatus {
  PENDING
  PAID
  OVERDUE
  PARTIALLY_PAID
}

enum ReceivableStatus {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
  PAGO_PARCIALMENTE
}

enum TipoContaContabilPrisma {
  ATIVO
  PASSIVO
  PATRIMONIO_LIQUIDO
  RECEITA
  DESPESA
}

enum TipoTransacaoPrisma {
  CREDITO
  DEBITO
}

enum ContaCorrenteType {
  BANCO
  FORNECEDOR_METAL
  EMPRESTIMO
  CLIENTE
}

enum StatusAnaliseQuimicaPrisma {
  RECEBIDO
  EM_ANALISE
  ANALISADO_AGUARDANDO_APROVACAO
  APROVADO_PARA_RECUPERACAO
  RECUSADO_PELO_CLIENTE
  EM_RECUPERACAO
  FINALIZADO_RECUPERADO
  CANCELADO
  RESIDUO
}

enum StatusRecuperacaoPrisma {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
}

enum PurchaseOrderStatus {
  PENDING
  RECEIVED
  CANCELED
}

enum RecoveryOrderStatusPrisma {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
  AGUARDANDO_RESULTADO
  AGUARDANDO_TEOR
}

enum TipoMetal {
  AU
  AG
  RH
}

enum PureMetalLotStatus {
  AVAILABLE
  USED
  PARTIALLY_USED
}

enum ChemicalReactionStatusPrisma {
  STARTED
  PROCESSING
  PENDING_PURITY
  PENDING_PURITY_ADJUSTMENT
  COMPLETED
  CANCELED
}

enum ReactionLeftoverType {
  BASKET
  DISTILLATE
}

enum ContaMetalType {
  CLIENTE
  FORNECEDOR
  INTERNA
  EMPRESTIMO
}

enum SaleStatus {
  PENDENTE
  CONFIRMADO
  A_SEPARAR
  SEPARADO
  FINALIZADO
  CANCELADO
  PAGO_PARCIALMENTE
}

enum SaleAdjustmentCalcMethod {
  QUANTITY_BASED
  COST_BASED
}

enum StockUnit {
  GRAMS
  KILOGRAMS
  LITERS
  UNITS
}

enum StockMovementType {
  ENTRY
  EXIT
  SALE
  PURCHASE
  ADJUSTMENT
}

enum MetalCreditStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELED
}
